<?php
/** @noinspection PhpMissingReturnTypeInspection */
/** @noinspection PhpFullyQualifiedNameUsageInspection */

/**
 * Hostinger API PHP SDK
 *
 * API Version: 0.0.99
 * @url https://github.com/hostinger/api-php-sdk
 *
 * NOTE: This file is auto-generated, DO NOT EDIT THIS FILE MANUALLY!
 * If you want to contribute or request a new feature, please create an issue or pull request on https://github.com/hostinger/api
 */

namespace Hostinger\Api;

use GuzzleHttp\Client;
use GuzzleHttp\ClientInterface;
use GuzzleHttp\Exception\ConnectException;
use GuzzleHttp\Exception\GuzzleException;
use GuzzleHttp\Exception\RequestException;
use GuzzleHttp\Psr7\Request;
use GuzzleHttp\RequestOptions;
use Symfony\Component\Serializer\Encoder\JsonEncoder;
use Symfony\Component\Serializer\Exception\ExceptionInterface;
use Symfony\Component\Serializer\Serializer;
use Hostinger\ApiException;
use Hostinger\Configuration;
use Hostinger\ObjectSerializer;

class VPSVirtualMachineApi
{
    protected ClientInterface $client;

    protected Configuration $config;

    protected Serializer $serializer;

    public function __construct(
        ?Configuration $config = null,
        ?ClientInterface $client = null,
    ) {
        $this->serializer = ObjectSerializer::getSerializer();
        $this->config = $config ?: Configuration::getDefaultConfiguration();
        $this->client = $client ?: new Client([
            'base_uri' => $this->config->getHost(),
        ]);
    }

    public function getConfig(): Configuration
    {
        return $this->config;
    }

    /**
     * @return \Hostinger\Model\VPSV1PublicKeyListResponse
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function getAttachedPublicKeysV1(int $virtualMachineId, ?int $page = null)
    {
        $query = http_build_query(
            array_filter(
                $this->serializer->normalize([
                        'page' => $page,
                ])
            )
        );

        $request = new Request(
            method: 'GET',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/public-keys', [
                'virtualMachineId' => $virtualMachineId
            ]) . '?' . $query,
            headers: $this->getHeaders(),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1PublicKeyListResponse', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1MetricsMetricsCollection
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function getMetricsV1(int $virtualMachineId, \DateTime $dateFrom, \DateTime $dateTo)
    {
        $query = http_build_query(
            array_filter(
                $this->serializer->normalize([
                        'date_from' => $dateFrom,
                        'date_to' => $dateTo,
                ])
            )
        );

        $request = new Request(
            method: 'GET',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/metrics', [
                'virtualMachineId' => $virtualMachineId
            ]) . '?' . $query,
            headers: $this->getHeaders(),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1MetricsMetricsCollection', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1VirtualMachineVirtualMachineResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function getVirtualMachineDetailsV1(int $virtualMachineId)
    {
        $request = new Request(
            method: 'GET',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1VirtualMachineVirtualMachineResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1VirtualMachineVirtualMachineResource[]
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function getVirtualMachinesV1()
    {
        $request = new Request(
            method: 'GET',
            uri: '/api/vps/v1/virtual-machines',
            headers: $this->getHeaders(),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1VirtualMachineVirtualMachineResource[]', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\BillingV1OrderVirtualMachineOrderResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function purchaseNewVirtualMachineV1(\Hostinger\Model\VPSV1VirtualMachinePurchaseRequest $vPSV1VirtualMachinePurchaseRequest)
    {
        $request = new Request(
            method: 'POST',
            uri: '/api/vps/v1/virtual-machines',
            headers: $this->getHeaders(),
            body: $this->serializer->serialize($vPSV1VirtualMachinePurchaseRequest, JsonEncoder::FORMAT),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\BillingV1OrderVirtualMachineOrderResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function recreateVirtualMachineV1(int $virtualMachineId, \Hostinger\Model\VPSV1VirtualMachineRecreateRequest $vPSV1VirtualMachineRecreateRequest)
    {
        $request = new Request(
            method: 'POST',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/recreate', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
            body: $this->serializer->serialize($vPSV1VirtualMachineRecreateRequest, JsonEncoder::FORMAT),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function resetHostnameV1(int $virtualMachineId)
    {
        $request = new Request(
            method: 'DELETE',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/hostname', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function restartVirtualMachineV1(int $virtualMachineId)
    {
        $request = new Request(
            method: 'POST',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/restart', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function setHostnameV1(int $virtualMachineId, \Hostinger\Model\VPSV1VirtualMachineHostnameUpdateRequest $vPSV1VirtualMachineHostnameUpdateRequest)
    {
        $request = new Request(
            method: 'PUT',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/hostname', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
            body: $this->serializer->serialize($vPSV1VirtualMachineHostnameUpdateRequest, JsonEncoder::FORMAT),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function setNameserversV1(int $virtualMachineId, \Hostinger\Model\VPSV1VirtualMachineNameserversUpdateRequest $vPSV1VirtualMachineNameserversUpdateRequest)
    {
        $request = new Request(
            method: 'PUT',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/nameservers', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
            body: $this->serializer->serialize($vPSV1VirtualMachineNameserversUpdateRequest, JsonEncoder::FORMAT),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function setPanelPasswordV1(int $virtualMachineId, \Hostinger\Model\VPSV1VirtualMachinePanelPasswordUpdateRequest $vPSV1VirtualMachinePanelPasswordUpdateRequest)
    {
        $request = new Request(
            method: 'PUT',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/panel-password', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
            body: $this->serializer->serialize($vPSV1VirtualMachinePanelPasswordUpdateRequest, JsonEncoder::FORMAT),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function setRootPasswordV1(int $virtualMachineId, \Hostinger\Model\VPSV1VirtualMachineRootPasswordUpdateRequest $vPSV1VirtualMachineRootPasswordUpdateRequest)
    {
        $request = new Request(
            method: 'PUT',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/root-password', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
            body: $this->serializer->serialize($vPSV1VirtualMachineRootPasswordUpdateRequest, JsonEncoder::FORMAT),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1VirtualMachineVirtualMachineResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function setupPurchasedVirtualMachineV1(int $virtualMachineId, \Hostinger\Model\VPSV1VirtualMachineSetupRequest $vPSV1VirtualMachineSetupRequest)
    {
        $request = new Request(
            method: 'POST',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/setup', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
            body: $this->serializer->serialize($vPSV1VirtualMachineSetupRequest, JsonEncoder::FORMAT),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1VirtualMachineVirtualMachineResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function startVirtualMachineV1(int $virtualMachineId)
    {
        $request = new Request(
            method: 'POST',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/start', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @return \Hostinger\Model\VPSV1ActionActionResource
     *
     * @throws ApiException
     * @throws GuzzleException
     * @throws ExceptionInterface
     */
    public function stopVirtualMachineV1(int $virtualMachineId)
    {
        $request = new Request(
            method: 'POST',
            uri: $this->buildResourcePath('/api/vps/v1/virtual-machines/{virtualMachineId}/stop', [
                'virtualMachineId' => $virtualMachineId
            ]),
            headers: $this->getHeaders(),
        );

        try {
            $response = $this->client->send($request, $this->createHttpClientOption());
        } catch (RequestException $e) {
            throw ApiException::fromRequestException($e);
        } catch (ConnectException $e) {
            throw ApiException::fromConnectException($e);
        }

        return $this->serializer->deserialize($response->getBody()->getContents(), '\Hostinger\Model\VPSV1ActionActionResource', JsonEncoder::FORMAT);
    }

    /**
     * @param array<string, mixed> $values
     */
    private function buildResourcePath(string $path, array $values): string
    {
        foreach ($values as $key => $value) {
            if (is_array($value)) {
                $value = implode(',', $value);
            }

            $path = str_replace('{' . $key . '}', $value, $path);
        }

        return $path;
    }

    /**
     * @return array<string, string>
     */
    private function getHeaders(): array
    {
        return [
            'Authorization' => 'Bearer ' . $this->config->getAccessToken(),
            'Content-Type' => 'application/json',
            'User-Agent' => $this->config->getUserAgent(),
        ];
    }

    /**
     * @return array<string, string>
     */
    private function createHttpClientOption(): array
    {
        $options = [];
        if ($this->config->getDebug()) {
            $options[RequestOptions::DEBUG] = fopen($this->config->getDebugFile(), 'a');
            if (!$options[RequestOptions::DEBUG]) {
                throw new \RuntimeException('Failed to open the debug file: ' . $this->config->getDebugFile());
            }
        }

        return $options;
    }
}
